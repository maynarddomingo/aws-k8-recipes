# frozen_string_literal: true

Vagrant.configure('2') do |config|
  config.vm.box = 'ubuntu/jammy64'

  # Master node
  config.vm.define 'k8s-master' do |master|
    master.vm.hostname = 'k8s-master'
    master.vm.network 'private_network', ip: '192.168.56.10'
    master.vm.provider 'virtualbox' do |vb|
      vb.memory = 8192
      vb.cpus = 4
    end

    master.vm.provision 'shell', inline: <<~SHELL
            echo "===== Step1: Update system ====="
            sudo apt-get update -y
            sudo apt-get install -y apt-transport-https ca-certificates curl gnupg lsb-release

            echo "===== Step2: Configure sysctl for Kubernetes ====="
            cat <<EOF | sudo tee /etc/sysctl.d/k8s.conf
      net.ipv4.ip_forward = 1
      net.bridge.bridge-nf-call-iptables = 1
      net.bridge.bridge-nf-call-ip6tables = 1
      EOF
            sudo sysctl --system

            echo "===== Step3: Install containerd ====="
            sudo apt-get install -y containerd
            sudo mkdir -p /etc/containerd
            containerd config default | sudo tee /etc/containerd/config.toml
            sudo systemctl restart containerd
            sudo systemctl enable containerd

            echo "===== Step4: Install kubeadm, kubelet, kubectl ====="
            sudo curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.28/deb/Release.key | \
              sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
            echo "deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.28/deb/ /" | \
              sudo tee /etc/apt/sources.list.d/kubernetes.list
            sudo apt-get update -y
            sudo apt-get install -y kubelet kubeadm kubectl
            sudo apt-mark hold kubelet kubeadm kubectl

            echo "===== Step4b: Enable required kernel modules ====="
            sudo modprobe br_netfilter
            echo 'br_netfilter' | sudo tee /etc/modules-load.d/br_netfilter.conf
            sudo sysctl -w net.bridge.bridge-nf-call-iptables=1
            sudo sysctl -w net.bridge.bridge-nf-call-ip6tables=1
            sudo sysctl -w net.ipv4.ip_forward=1
            cat <<EOF | sudo tee /etc/sysctl.d/k8s.conf
            net.bridge.bridge-nf-call-iptables=1
            net.bridge.bridge-nf-call-ip6tables=1
            net.ipv4.ip_forward=1
      EOF
      sudo sysctl --system

            echo "===== Step5: Reset & Init Kubernetes Master ====="
            # Reset cluster if any leftovers exist
            sudo kubeadm reset -f || true
            sudo systemctl restart containerd
            sudo rm -rf /etc/cni/net.d /var/lib/cni /var/lib/kubelet /etc/kubernetes /var/lib/etcd

            # Ensure br_netfilter is loaded
            sudo modprobe br_netfilter
            cat <<EOF | sudo tee /etc/modules-load.d/k8s.conf
      br_netfilter
      EOF

            # Sysctl params required by Kubernetes
            cat <<EOF | sudo tee /etc/sysctl.d/k8s.conf
      net.bridge.bridge-nf-call-iptables  = 1
      net.bridge.bridge-nf-call-ip6tables = 1
      EOF
            sudo sysctl --system

            # Pre-pull images to avoid init timeout
            sudo kubeadm config images pull --kubernetes-version=v1.28.15

            # Init master

            sudo kubeadm init \
            --apiserver-advertise-address=192.168.56.10 \
            --pod-network-cidr=192.168.0.0/16 \
            --kubernetes-version=v1.28.15

            echo "===== Step6: Configure kubectl for vagrant user ====="
            if [ -f /etc/kubernetes/admin.conf ]; then
              mkdir -p /home/vagrant/.kube
              sudo cp -i /etc/kubernetes/admin.conf /home/vagrant/.kube/config
              sudo chown vagrant:vagrant /home/vagrant/.kube/config
              echo "âœ… kubectl configured for vagrant user."
            else
              echo "âš ï¸  Skipping kubectl config: /etc/kubernetes/admin.conf not found (init may have failed)."
            fi

            echo "===== Step7: Apply CNI (Calico) ====="
            if [ -f /home/vagrant/.kube/config ]; then
              echo "â³ Waiting for kube-apiserver to be ready..."
              until sudo -u vagrant kubectl get nodes >/dev/null 2>&1; do
                echo "   ...still waiting..."
                sleep 10
              done
             echo "âœ… API server is responding, applying Calico..."
             sudo -u vagrant kubectl apply -f https://raw.githubusercontent.com/projectcalico/calico/v3.26.1/manifests/calico.yaml
            else
              echo "âš ï¸  Skipping CNI install: kubeconfig not found."
            fi
      #{'    '}
            echo "===== Step8: Apply CNI (Calico) ====="
            echo "â³ Waiting for kube-apiserver to be ready..."
      for i in {1..30}; do
        if sudo -u vagrant kubectl get --raw=/healthz 2>/dev/null | grep -q "ok"; then
          echo "âœ… API server is healthy, applying Calico..."
          sudo -u vagrant kubectl apply -f https://raw.githubusercontent.com/projectcalico/calico/v3.26.1/manifests/calico.yaml
          break
        else
          echo "   ...still waiting (attempt $i)..."
          sleep 10
        fi
      done

            echo "ðŸŽ‰ Kubernetes master setup complete!"
    SHELL
  end
  # Worker nodes
  (1..2).each do |i|
    config.vm.define "k8s-worker#{i}" do |worker|
      worker.vm.hostname = "k8s-worker#{i}"
      worker.vm.network 'private_network', ip: "192.168.56.1#{i}"
      worker.vm.provider 'virtualbox' do |vb|
        vb.memory = '2048'
        vb.cpus = 2
      end

      worker.vm.provision 'shell', inline: <<~SHELL
                        #!/bin/bash
                        set -e
                        echo "===== Worker#{i}: Update & dependencies ====="
                        sudo apt-get update
                        sudo apt-get install -y apt-transport-https ca-certificates curl software-properties-common gnupg lsb-release

                        echo "===== Worker#{i}: Install containerd ====="
                        sudo apt-get install -y containerd
                        sudo mkdir -p /etc/containerd
                        sudo containerd config default | sudo tee /etc/containerd/config.toml
                        sudo systemctl restart containerd
                        sudo systemctl enable containerd

                        echo "===== Worker#{i}: Disable swap ====="
                        sudo swapoff -a
                        sudo sed -i '/ swap / s/^/#/' /etc/fstab

                        echo "===== Worker#{i}: Kernel modules & sysctl ====="
                        sudo modprobe br_netfilter
                        echo "br_netfilter" | sudo tee /etc/modules-load.d/k8s.conf
                        cat <<EOF | sudo tee /etc/sysctl.d/k8s.conf
                net.bridge.bridge-nf-call-iptables = 1
                net.bridge.bridge-nf-call-ip6tables = 1
                net.ipv4.ip_forward = 1
                EOF
                        sudo sysctl --system

                        echo "===== Worker#{i}: Install kubeadm, kubelet, kubectl ====="
                        sudo mkdir -p /etc/apt/keyrings
                        curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.28/deb/Release.key | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg

                        echo "deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] \
                        https://pkgs.k8s.io/core:/stable:/v1.28/deb/ /" | \
                        sudo tee /etc/apt/sources.list.d/kubernetes.list

                        sudo apt-get update -y
                        sudo apt-get install -y kubelet kubeadm kubectl
                        sudo apt-mark hold kubelet kubeadm kubectl

                        echo "===== Worker#{i}: Ready to join cluster ====="
                        echo "ðŸ‘‰ Run 'kubeadm token create --print-join-command' on master and paste here."
      SHELL
    end
  end
end
